<!-- Copyright 2026 LUCI Mobility, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License. -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WDI Compatibility Tester</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #111827;
      color: #fff;
      min-height: 100vh;
      padding: 1rem;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: bold;
      color: #60a5fa;
    }

    header p {
      font-size: 0.875rem;
      color: #9ca3af;
    }

    .grid {
      display: grid;
      gap: 1rem;
      margin-top: 1.5rem;
    }

    @media (min-width: 1024px) {
      .grid-3 {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .panel {
      background: #1f2937;
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .panel-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: #93c5fd;
      margin-bottom: 0.75rem;
    }

    .btn {
      width: 100%;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      color: white;
      transition: background 0.2s;
      margin-bottom: 0.5rem;
    }

    .btn-blue {
      background: #2563eb;
    }

    .btn-blue:hover {
      background: #1d4ed8;
    }

    .btn-red {
      background: #dc2626;
    }

    .btn-red:hover {
      background: #b91c1c;
    }

    .error-box {
      margin-top: 0.75rem;
      background: rgba(127, 29, 29, 0.5);
      border: 1px solid #ef4444;
      border-radius: 0.5rem;
      padding: 0.75rem;
      font-size: 0.875rem;
      color: #fecaca;
    }

    .info-box {
      background: #374151;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-top: 0.5rem;
    }

    .info-box .name {
      font-weight: 500;
      color: #4ade80;
    }

    .info-box .vid {
      color: #9ca3af;
      font-size: 0.875rem;
    }

    .info-box.active {
      border: 2px solid #4ade80;
    }

    .source-badge {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin-left: 0.5rem;
    }

    .source-hid {
      background: #7c3aed;
    }

    .source-gamepad {
      background: #0891b2;
    }

    .source-kbd {
      background: #ca8a04;
    }

    .command-display {
      border-radius: 0.5rem;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .command-display .cmd {
      font-size: 1.25rem;
      font-weight: bold;
    }

    .joystick-container {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .joystick {
      position: relative;
      width: 128px;
      height: 128px;
      background: #374151;
      border-radius: 50%;
      border: 2px solid #4b5563;
    }

    .joystick .crosshair-v {
      position: absolute;
      left: 50%;
      top: 0;
      width: 1px;
      height: 100%;
      background: #4b5563;
    }

    .joystick .crosshair-h {
      position: absolute;
      top: 50%;
      left: 0;
      height: 1px;
      width: 100%;
      background: #4b5563;
    }

    .joystick .knob {
      position: absolute;
      width: 24px;
      height: 24px;
      background: #3b82f6;
      border-radius: 50%;
      border: 2px solid #93c5fd;
      transform: translate(-50%, -50%);
      transition: all 0.05s;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      font-size: 0.875rem;
    }

    .status-item {
      background: #374151;
      border-radius: 0.5rem;
      padding: 0.5rem;
    }

    .status-item .label {
      color: #9ca3af;
    }

    .status-item.active {
      background: #dc2626;
    }

    .status-item.active-green {
      background: #16a34a;
    }

    .status-item.inactive {
      background: #374151;
    }

    .indicators {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
      margin-top: 1rem;
    }

    .indicator {
      width: 32px;
      height: 32px;
      border-radius: 0.25rem;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #374151;
    }

    .indicator.on-orange {
      background: #f97316;
    }

    .indicator.on-yellow {
      background: #facc15;
      color: #000;
    }

    .indicator.on-red {
      background: #ef4444;
    }

    .indicator.on-blue {
      background: #3b82f6;
    }

    .raw-box {
      background: #374151;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .raw-box .label {
      color: #9ca3af;
      font-size: 0.75rem;
      margin-bottom: 0.25rem;
    }

    .raw-box .hex {
      font-family: monospace;
      color: #4ade80;
      word-break: break-all;
    }

    .axis-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .axis-row .name {
      width: 3rem;
      color: #9ca3af;
      font-size: 0.75rem;
    }

    .axis-row .bar {
      flex: 1;
      background: #4b5563;
      border-radius: 0.25rem;
      height: 1rem;
      overflow: hidden;
    }

    .axis-row .bar-fill {
      height: 100%;
      background: #3b82f6;
      transition: width 0.05s;
    }

    .axis-row .value {
      width: 4rem;
      text-align: right;
      font-family: monospace;
      font-size: 0.75rem;
    }

    .button-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
    }

    .button-item {
      width: 28px;
      height: 28px;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      background: #4b5563;
    }

    .button-item.pressed {
      background: #22c55e;
    }

    .event-log {
      height: 192px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.75rem;
    }

    .event-row {
      display: flex;
      gap: 0.5rem;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      color: #d1d5db;
    }

    .event-row:hover {
      background: #374151;
    }

    .event-row .ts {
      color: #6b7280;
    }

    .event-row .src {
      padding: 0 0.25rem;
      border-radius: 0.125rem;
      font-size: 0.625rem;
    }

    .event-row .src-hid {
      background: #7c3aed;
    }

    .event-row .src-gp {
      background: #0891b2;
    }

    .event-row .src-kbd {
      background: #ca8a04;
    }

    .event-row .data {
      color: #4ade80;
      flex: 1;
    }

    .event-row .btns {
      color: #facc15;
    }

    .mapping-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      font-size: 0.8rem;
    }

    @media (min-width: 768px) {
      .mapping-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .mapping-item {
      background: #374151;
      border-radius: 0.5rem;
      padding: 0.5rem;
    }

    .mapping-item .label {
      color: #9ca3af;
    }

    .placeholder {
      color: #6b7280;
      text-align: center;
      padding: 2rem;
    }

    .gamepad-list {
      margin-top: 0.5rem;
    }

    .gamepad-item {
      background: #374151;
      border-radius: 0.5rem;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      cursor: pointer;
      border: 2px solid transparent;
    }

    .gamepad-item:hover {
      border-color: #4b5563;
    }

    .gamepad-item.selected {
      border-color: #4ade80;
    }

    .gamepad-item .gp-name {
      font-size: 0.875rem;
      color: #d1d5db;
    }

    .gamepad-item .gp-id {
      font-size: 0.75rem;
      color: #6b7280;
    }

    .section-label {
      font-size: 0.75rem;
      color: #9ca3af;
      margin: 0.75rem 0 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .bg-gray {
      background: #6b7280;
    }

    .bg-green {
      background: #16a34a;
    }

    .bg-purple {
      background: #9333ea;
    }

    .bg-purple-light {
      background: #a855f7;
    }

    .bg-red {
      background: #dc2626;
    }

    .divider {
      border-top: 1px solid #374151;
      margin: 1rem 0;
    }

    #keyboardCapture:focus {
      border-color: #4ade80;
      background: #1f2937;
    }

    #keyboardCapture.active {
      border-color: #4ade80;
    }

    .control-indicator {
      padding: 0.75rem;
      border-radius: 0.5rem;
      text-align: center;
      margin-bottom: 1rem;
      font-weight: 600;
    }

    .control-active {
      background: #16a34a;
    }

    .control-inactive {
      background: #991b1b;
    }

    .tab-btn {
      padding: 0.5rem 1rem;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      background: #374151;
      color: #9ca3af;
    }

    .tab-btn.active {
      background: #4b5563;
      color: #fff;
    }

    .tab-btn:first-child {
      border-radius: 0.375rem 0 0 0.375rem;
    }

    .tab-btn:last-child {
      border-radius: 0 0.375rem 0.375rem 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>WDI Compatibility Tester</h1>
      <p>Wheelchair Digital Interface - HID Device Testing Tool</p>
    </header>

    <div class="grid grid-3">
      <div class="panel">
        <div class="panel-title">Device Connection</div>

        <div class="section-label">WebHID (Raw HID Access)</div>
        <button id="hidBtn" class="btn btn-blue">Connect HID Device</button>
        <div id="hidInfo" style="display:none"></div>
        <div id="hidError" class="error-box" style="display:none"></div>

        <div class="divider"></div>

        <div class="section-label">Gamepad API (Xbox, PlayStation, etc.)</div>
        <div id="browserWarning"
          style="display:none;background:#78350f;border:1px solid #f59e0b;border-radius:0.375rem;padding:0.5rem;margin-bottom:0.5rem;font-size:0.75rem;color:#fef3c7;">
          ‚ö†Ô∏è <strong>Chrome detected:</strong> Button indices may be remapped for custom devices. Use Firefox for
          accurate WDI testing.
        </div>
        <div id="gamepadStatus" style="font-size:0.875rem;color:#9ca3af;margin-bottom:0.5rem;">Press a button on your
          controller to detect it</div>
        <div id="gamepadList" class="gamepad-list"></div>

        <div class="divider"></div>

        <div class="section-label">Keyboard</div>
        <div id="keyboardStatus" style="font-size:0.875rem;color:#9ca3af;margin-bottom:0.5rem;">Click the box below and
          use keys to control</div>
        <div id="keyboardCapture" tabindex="0"
          style="background:#374151;border-radius:0.5rem;padding:1rem;text-align:center;cursor:pointer;border:2px solid #4b5563;outline:none;">
          <div style="color:#6b7280;font-size:0.875rem;">Click here to capture keyboard</div>
          <div id="activeKeys" style="margin-top:0.5rem;min-height:1.5rem;color:#4ade80;font-family:monospace;"></div>
        </div>

        <div class="divider"></div>

        <div class="section-label">Active Input Source</div>
        <div id="activeSource" class="info-box">
          <span style="color:#6b7280;">None connected</span>
        </div>

        <div class="divider"></div>
        <label style="font-size:0.75rem;color:#9ca3af;display:flex;align-items:center;gap:0.5rem;cursor:pointer;">
          <input type="checkbox" id="debugMode"> Enable debug logging (check console)
        </label>
      </div>

      <div class="panel">
        <div class="panel-title">WDI Wheelchair Output</div>

        <div id="controlIndicator" class="control-indicator control-inactive">
          DEVICE CONTROL: INACTIVE
        </div>

        <div id="commandDisplay" class="command-display bg-gray">
          <div class="cmd">DRIVE: STOPPED</div>
        </div>
        <div class="joystick-container">
          <div class="joystick">
            <div class="crosshair-v"></div>
            <div class="crosshair-h"></div>
            <div class="knob" id="joystickKnob" style="left:50%;top:50%"></div>
          </div>
        </div>
        <div class="status-grid">
          <div class="status-item"><span class="label">Mode:</span> <span id="modeValue"
              style="color:#4ade80;font-weight:500;margin-left:0.5rem">DRIVE</span></div>
          <div class="status-item"><span class="label">Speed:</span> <span id="speedValue"
              style="color:#facc15;font-weight:500;margin-left:0.5rem">3/5</span></div>
          <div class="status-item"><span class="label">Profile:</span> <span id="profileValue"
              style="color:#22d3ee;font-weight:500;margin-left:0.5rem">1</span></div>
          <div class="status-item" id="estopItem"><span class="label">E-Stop:</span> <span id="estopValue"
              style="font-weight:500;margin-left:0.5rem">Off</span></div>
        </div>
        <div class="indicators">
          <div class="indicator" id="indLeft">‚óÄ</div>
          <div class="indicator" id="indLight">üí°</div>
          <div class="indicator" id="indHazard">‚ö†</div>
          <div class="indicator" id="indHorn">üîä</div>
          <div class="indicator" id="indRight">‚ñ∂</div>
        </div>

        <div class="divider"></div>
        <div class="section-label">Seating Controls</div>
        <div id="seatingMemory" style="font-size:0.75rem;color:#6b7280;margin-bottom:0.5rem;">Memory Position: <span
            id="memoryValue" style="color:#9ca3af;">None</span></div>
        <div id="seatingActuators"
          style="display:grid;grid-template-columns:repeat(3,1fr);gap:0.25rem;font-size:0.7rem;">
          <div class="status-item" id="actTilt" style="padding:0.375rem;text-align:center;"><span
              class="label">Tilt</span>
            <div id="actTiltDir" style="color:#6b7280;">-</div>
          </div>
          <div class="status-item" id="actRecline" style="padding:0.375rem;text-align:center;"><span
              class="label">Recline</span>
            <div id="actReclineDir" style="color:#6b7280;">-</div>
          </div>
          <div class="status-item" id="actLegrest" style="padding:0.375rem;text-align:center;"><span
              class="label">Legrest</span>
            <div id="actLegrestDir" style="color:#6b7280;">-</div>
          </div>
          <div class="status-item" id="actElevate" style="padding:0.375rem;text-align:center;"><span
              class="label">Elevate</span>
            <div id="actElevateDir" style="color:#6b7280;">-</div>
          </div>
          <div class="status-item" id="actFootplates" style="padding:0.375rem;text-align:center;"><span
              class="label">Footplates</span>
            <div id="actFootplatesDir" style="color:#6b7280;">-</div>
          </div>
          <div class="status-item" id="actStand" style="padding:0.375rem;text-align:center;"><span
              class="label">Stand</span>
            <div id="actStandDir" style="color:#6b7280;">-</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Raw Input Data</div>
        <div id="rawDataContainer">
          <div class="placeholder">Connect a device to see input data</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:1rem">
      <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;">
        <span>WDI Button Mapping Reference</span>
        <div>
          <button class="tab-btn active" id="tabGamepad">Gamepad</button>
          <button class="tab-btn" id="tabKeyboard">Keyboard</button>
        </div>
      </div>
      <div id="mappingGamepad">
        <p style="font-size:0.75rem;color:#9ca3af;margin-bottom:0.75rem;">Standard gamepad mapping (Xbox layout)</p>
        <div class="mapping-grid">
          <div class="mapping-item"><span class="label">Left Stick:</span> Drive Direction</div>
          <div class="mapping-item"><span class="label">A (South):</span> Emergency Stop</div>
          <div class="mapping-item"><span class="label">Start:</span> Device Control Toggle</div>
          <div class="mapping-item"><span class="label">Back/Select:</span> Menu / Wake</div>
          <div class="mapping-item"><span class="label">LB/RB:</span> Speed Down/Up</div>
          <div class="mapping-item"><span class="label">D-Pad Up:</span> Profile Up</div>
          <div class="mapping-item"><span class="label">D-Pad Down:</span> Mode Switch</div>
          <div class="mapping-item"><span class="label">D-Pad L/R:</span> Blinkers</div>
          <div class="mapping-item"><span class="label">L3 (Left Stick):</span> Headlight</div>
          <div class="mapping-item"><span class="label">Y (West):</span> Hazard Lights</div>
          <div class="mapping-item"><span class="label">R3 (Right Stick):</span> Horn (hold)</div>
        </div>
        <p style="font-size:0.7rem;color:#6b7280;margin-top:0.75rem;"><strong>Custom HID:</strong> BTN_C (btn 17) =
          Enable Control, BTN_MODE (btn 16) = Disable Control (edge-triggered on press)</p>
        <p style="font-size:0.7rem;color:#6b7280;margin-top:0.5rem;"><strong>Seating:</strong> Uses BTN_TRIGGER_HAPPY
          buttons (20+) not available on standard gamepads. Memory 1-7: BTN 20-26. Actuators use BTN 28-33, with BTN 27
          as down modifier.</p>
      </div>
      <div id="mappingKeyboard" style="display:none;">
        <p style="font-size:0.75rem;color:#9ca3af;margin-bottom:0.75rem;">Keyboard controls per WDI spec</p>
        <div class="mapping-grid">
          <div class="mapping-item"><span class="label">‚Üë/W, ‚Üì/S:</span> Forward/Back</div>
          <div class="mapping-item"><span class="label">‚Üê/A, ‚Üí/D:</span> Left/Right</div>
          <div class="mapping-item"><span class="label">Enter:</span> Device Control Toggle</div>
          <div class="mapping-item"><span class="label">PgUp/PgDn/B:</span> Emergency Stop</div>
          <div class="mapping-item"><span class="label">1-5:</span> Set Speed Level</div>
          <div class="mapping-item"><span class="label">-/=:</span> Speed Down/Up</div>
          <div class="mapping-item"><span class="label">,/. :</span> Profile Down/Up</div>
          <div class="mapping-item"><span class="label">Tab:</span> Mode Switch</div>
          <div class="mapping-item"><span class="label">O:</span> Open Menu</div>
          <div class="mapping-item"><span class="label">L:</span> Headlight</div>
          <div class="mapping-item"><span class="label">H:</span> Hazard Lights</div>
          <div class="mapping-item"><span class="label">&lt;/&gt;:</span> Left/Right Blinker</div>
          <div class="mapping-item"><span class="label">Space:</span> Horn (hold)</div>
          <div class="mapping-item"><span class="label">Escape:</span> Power/Sleep</div>
        </div>
      </div>
    </div>

    <div class="panel" style="margin-top:1rem">
      <div class="panel-title">Event Log</div>
      <div class="event-log" id="eventLog">
        <div class="placeholder">No events recorded</div>
      </div>
    </div>
  </div>

  <script>
    var hidDevice = null;
    var hidConnected = false;
    var selectedGamepadIndex = null;
    var activeSource = null;
    var eventId = 0;
    var events = [];
    var wdiState = {
      forward: 0, turn: 0, speed: 3, mode: 'drive', profile: 1,
      eStop: false, headlight: false, hazards: false,
      leftBlinker: false, rightBlinker: false, horn: false,
      deviceControlActive: false, menuOpen: false
    };
    var seatingState = {
      memory: null,
      tilt: 0, recline: 0, legrest: 0, elevate: 0, footplates: 0, stand: 0
    };
    // BTN_TRIGGER_HAPPY button indices
    // BTN_TRIGGER_HAPPY1 starts at index 20 in Gamepad API
    var SEATING_BTN = {
      MEMORY_1: 20,       // BTN_TRIGGER_HAPPY1
      MEMORY_2: 21,       // BTN_TRIGGER_HAPPY2
      MEMORY_3: 22,       // BTN_TRIGGER_HAPPY3
      MEMORY_4: 23,       // BTN_TRIGGER_HAPPY4
      MEMORY_5: 24,       // BTN_TRIGGER_HAPPY5
      MEMORY_6: 25,       // BTN_TRIGGER_HAPPY6
      MEMORY_HOME: 26,    // BTN_TRIGGER_HAPPY7
      DOWN_MOD: 27,       // BTN_TRIGGER_HAPPY8 = Down/backward modifier
      TILT: 28,           // BTN_TRIGGER_HAPPY9
      RECLINE: 29,        // BTN_TRIGGER_HAPPY10
      LEGREST: 30,        // BTN_TRIGGER_HAPPY11
      ELEVATE: 31,        // BTN_TRIGGER_HAPPY12
      FOOTPLATES: 32,     // BTN_TRIGGER_HAPPY13
      STAND: 33           // BTN_TRIGGER_HAPPY14
    };
    var prevButtonStates = {};
    var gamepadPollId = null;

    function $(id) { return document.getElementById(id); }

    // Detect Chrome and show warning
    var isChrome = /Chrome/.test(navigator.userAgent) && !/Edg/.test(navigator.userAgent);
    if (isChrome) {
      $('browserWarning').style.display = 'block';
    }

    $('tabGamepad').onclick = function () {
      $('tabGamepad').classList.add('active');
      $('tabKeyboard').classList.remove('active');
      $('mappingGamepad').style.display = 'block';
      $('mappingKeyboard').style.display = 'none';
    };
    $('tabKeyboard').onclick = function () {
      $('tabKeyboard').classList.add('active');
      $('tabGamepad').classList.remove('active');
      $('mappingKeyboard').style.display = 'block';
      $('mappingGamepad').style.display = 'none';
    };

    function setMappingTab(source) {
      if (source === 'keyboard') {
        $('tabKeyboard').click();
      } else {
        $('tabGamepad').click();
      }
    }

    function showHidError(msg) {
      $('hidError').textContent = msg;
      $('hidError').style.display = msg ? 'block' : 'none';
    }

    function parseHIDReport(reportId, data) {
      var bytes = Array.from(new Uint8Array(data.buffer));
      var parsed = { reportId: reportId, bytes: bytes, hex: bytes.map(function (b) { return b.toString(16).padStart(2, '0'); }).join(' '), axes: [], buttons: [] };
      if (bytes.length >= 2) {
        parsed.axes.push({ name: 'X', raw: bytes[0], norm: (bytes[0] - 127) / 127 });
        parsed.axes.push({ name: 'Y', raw: bytes[1], norm: (bytes[1] - 127) / 127 });
      }
      if (bytes.length >= 4) {
        parsed.axes.push({ name: 'Z', raw: bytes[2], norm: (bytes[2] - 127) / 127 });
        parsed.axes.push({ name: 'Rz', raw: bytes[3], norm: (bytes[3] - 127) / 127 });
      }
      for (var byteIdx = 4; byteIdx < Math.min(bytes.length, 8); byteIdx++) {
        for (var bit = 0; bit < 8; bit++) {
          parsed.buttons.push({ id: (byteIdx - 4) * 8 + bit, pressed: !!(bytes[byteIdx] & (1 << bit)) });
        }
      }
      return parsed;
    }

    function handleHIDReport(e) {
      var parsed = parseHIDReport(e.reportId, e.data);
      activeSource = 'hid';
      setMappingTab('gamepad');
      processInput({
        source: 'hid',
        axes: parsed.axes.map(function (a) { return a.norm; }),
        buttons: parsed.buttons.map(function (b) { return b.pressed; }),
        raw: parsed
      });
    }

    async function connectHID() {
      showHidError('');
      if (!('hid' in navigator)) { showHidError('WebHID not supported. Use Chrome/Edge/Opera.'); return; }
      try {
        var devices = await navigator.hid.requestDevice({ filters: [] });
        if (!devices.length) { showHidError('No device selected'); return; }
        hidDevice = devices[0];
        if (!hidDevice.opened) await hidDevice.open();

        var html = '<div class="info-box active"><div class="name">' + (hidDevice.productName || 'Unknown Device') + '<span class="source-badge source-hid">HID</span></div>';
        html += '<div class="vid">VID: 0x' + hidDevice.vendorId.toString(16).padStart(4, '0') + ' | PID: 0x' + hidDevice.productId.toString(16).padStart(4, '0') + '</div></div>';
        $('hidInfo').innerHTML = html;
        $('hidInfo').style.display = 'block';

        hidDevice.addEventListener('inputreport', handleHIDReport);
        hidConnected = true;
        activeSource = 'hid';
        $('hidBtn').textContent = 'Disconnect HID';
        $('hidBtn').className = 'btn btn-red';
        updateActiveSource();
      } catch (err) {
        showHidError('Connection failed: ' + (err.message || err.name));
      }
    }

    async function disconnectHID() {
      if (hidDevice) {
        hidDevice.removeEventListener('inputreport', handleHIDReport);
        try { await hidDevice.close(); } catch (e) { }
        hidDevice = null;
      }
      hidConnected = false;
      if (activeSource === 'hid') activeSource = selectedGamepadIndex !== null ? 'gamepad' : null;
      $('hidBtn').textContent = 'Connect HID Device';
      $('hidBtn').className = 'btn btn-blue';
      $('hidInfo').style.display = 'none';
      updateActiveSource();
    }

    $('hidBtn').onclick = function () { hidConnected ? disconnectHID() : connectHID(); };

    function updateGamepadList() {
      var gamepads = navigator.getGamepads();
      var currentIds = [];
      for (var i = 0; i < gamepads.length; i++) {
        if (gamepads[i]) currentIds.push(i + ':' + gamepads[i].id);
      }
      var newListKey = currentIds.join('|');
      if (newListKey === updateGamepadList.lastListKey && updateGamepadList.lastSelected === selectedGamepadIndex) {
        return;
      }
      updateGamepadList.lastListKey = newListKey;
      updateGamepadList.lastSelected = selectedGamepadIndex;

      var html = '';
      var found = false;
      for (var i = 0; i < gamepads.length; i++) {
        var gp = gamepads[i];
        if (gp) {
          found = true;
          var selected = selectedGamepadIndex === i;
          html += '<div class="gamepad-item' + (selected ? ' selected' : '') + '" data-index="' + i + '">';
          html += '<div class="gp-name">' + gp.id.split('(')[0].trim() + '<span class="source-badge source-gamepad">Gamepad</span></div>';
          html += '<div class="gp-id">' + gp.buttons.length + ' buttons, ' + gp.axes.length + ' axes, mapping: ' + (gp.mapping || 'non-standard') + '</div></div>';
        }
      }
      $('gamepadList').innerHTML = html;
      $('gamepadStatus').textContent = found ? 'Click a controller to select it:' : 'Press a button on your controller to detect it';

      var items = document.querySelectorAll('.gamepad-item');
      for (var j = 0; j < items.length; j++) {
        items[j].onclick = function (e) {
          e.stopPropagation();
          var idx = parseInt(this.dataset.index);
          console.log('Selecting gamepad:', idx);
          selectedGamepadIndex = idx;
          activeSource = 'gamepad';
          setMappingTab('gamepad');
          updateGamepadList.lastSelected = -999;
          updateGamepadList();
          updateActiveSource();
        };
      }
    }
    updateGamepadList.lastListKey = '';
    updateGamepadList.lastSelected = null;

    function pollGamepad() {
      var gamepads = navigator.getGamepads();
      updateGamepadList();

      if (selectedGamepadIndex !== null && gamepads[selectedGamepadIndex]) {
        var gp = gamepads[selectedGamepadIndex];
        activeSource = 'gamepad';

        var buttonStates = [];
        for (var i = 0; i < gp.buttons.length; i++) {
          var b = gp.buttons[i];
          if (typeof b === 'object') {
            buttonStates.push(b.pressed || b.value > 0.5);
          } else {
            buttonStates.push(!!b);
          }
        }

        if ($('debugMode').checked) {
          var anyPressed = buttonStates.some(function (b) { return b; });
          var anyAxisMoved = false;
          for (var k = 0; k < gp.axes.length; k++) {
            if (Math.abs(gp.axes[k]) > 0.1) anyAxisMoved = true;
          }
          if (anyPressed || anyAxisMoved) {
            console.log('Gamepad raw:', {
              id: gp.id,
              mapping: gp.mapping,
              axes: Array.from(gp.axes),
              buttons: gp.buttons.map(function (b, i) { return { i: i, pressed: b.pressed, value: b.value }; }),
              buttonStates: buttonStates
            });
          }
        }

        processInput({
          source: 'gamepad',
          axes: Array.from(gp.axes),
          buttons: buttonStates,
          raw: { axes: gp.axes, buttons: gp.buttons }
        });
      }

      gamepadPollId = requestAnimationFrame(pollGamepad);
    }

    window.addEventListener('gamepadconnected', function (e) {
      if (selectedGamepadIndex === null) {
        selectedGamepadIndex = e.gamepad.index;
        activeSource = 'gamepad';
        setMappingTab('gamepad');
      }
      updateGamepadList();
      updateActiveSource();
    });

    window.addEventListener('gamepaddisconnected', function (e) {
      if (selectedGamepadIndex === e.gamepad.index) {
        selectedGamepadIndex = null;
        if (activeSource === 'gamepad') activeSource = hidConnected ? 'hid' : null;
      }
      updateGamepadList();
      updateActiveSource();
    });

    function processInput(input) {
      var source = input.source;
      var axes = input.axes;
      var buttons = input.buttons;
      var raw = input.raw;

      var btnKey = source + '-btn';
      if (!prevButtonStates[btnKey]) {
        prevButtonStates[btnKey] = [];
      }
      var prevStates = prevButtonStates[btnKey];

      function justPressed(i) {
        var now = buttons[i] || false;
        var prev = prevStates[i] || false;
        return now && !prev;
      }

      // Debug logging for BTN_C (17) and BTN_MODE (16)
      if ($('debugMode').checked) {
        var b16 = buttons[16] || false;
        var b17 = buttons[17] || false;
        var p16 = prevStates[16] || false;
        var p17 = prevStates[17] || false;
        if (b16 || b17 || p16 || p17) {
          var jp16 = b16 && !p16;
          var jp17 = b17 && !p17;
          console.log('BTN_C/MODE debug:', {
            btn16_now: b16, btn16_prev: p16, btn16_justPressed: jp16,
            btn17_now: b17, btn17_prev: p17, btn17_justPressed: jp17,
            prevStateLength: prevStates.length, buttonsLength: buttons.length
          });
          if (jp17) console.log('>>> ENABLING CONTROL (btn 17 rising edge)');
          if (jp16) console.log('>>> DISABLING CONTROL (btn 16 rising edge)');
        }
      }

      // BTN_C (17) = enable control, BTN_MODE (16) = disable control
      if (justPressed(17)) {
        wdiState.deviceControlActive = true;
      }
      if (justPressed(16)) {
        wdiState.deviceControlActive = false;
      }

      // Standard indices for HID
      if (justPressed(2) && buttons.length <= 17) {
        wdiState.deviceControlActive = true;
      }

      // Drive only if device control is active
      if (wdiState.deviceControlActive && axes.length >= 2) {
        var x = axes[0];
        var y = axes[1];
        wdiState.turn = Math.abs(x) > 0.1 ? x : 0;
        wdiState.forward = Math.abs(y) > 0.1 ? -y : 0;
      } else if (!wdiState.deviceControlActive) {
        wdiState.turn = 0;
        wdiState.forward = 0;
      }

      // WDI Gamepad Mappings
      wdiState.eStop = buttons[0] || false;
      wdiState.horn = buttons[11] || false;

      if (justPressed(9)) wdiState.deviceControlActive = !wdiState.deviceControlActive;
      if (justPressed(8)) wdiState.menuOpen = !wdiState.menuOpen;
      if (justPressed(4) && wdiState.speed > 1) wdiState.speed--;
      if (justPressed(5) && wdiState.speed < 5) wdiState.speed++;
      if (justPressed(12)) wdiState.profile = wdiState.profile >= 5 ? 1 : wdiState.profile + 1;
      if (justPressed(13)) wdiState.mode = wdiState.mode === 'drive' ? 'seating' : 'drive';
      if (justPressed(14)) wdiState.leftBlinker = !wdiState.leftBlinker;
      if (justPressed(15)) wdiState.rightBlinker = !wdiState.rightBlinker;
      if (justPressed(10)) wdiState.headlight = !wdiState.headlight;
      if (justPressed(3)) wdiState.hazards = !wdiState.hazards;

      // Seating controls (BTN_TRIGGER_HAPPY buttons)
      processSeating(buttons);

      // Update prev states AFTER all checks
      prevButtonStates[btnKey] = buttons.slice();

      updateWDIDisplay();
      updateRawDisplay(source, axes, buttons, raw);

      var pressedBtns = [];
      for (var i = 0; i < buttons.length; i++) {
        if (buttons[i] && i !== 16 && i !== 17) pressedBtns.push(i);
      }
      if (pressedBtns.length > 0 || Math.abs(wdiState.forward) > 0.1 || Math.abs(wdiState.turn) > 0.1) {
        addEvent(source, axes, pressedBtns, raw);
      }
    }

    function updateActiveSource() {
      var html = '';
      if (activeSource === 'hid' && hidDevice) {
        html = '<span class="name">' + (hidDevice.productName || 'HID Device') + '</span><span class="source-badge source-hid">HID</span>';
      } else if (activeSource === 'gamepad' && selectedGamepadIndex !== null) {
        var gp = navigator.getGamepads()[selectedGamepadIndex];
        if (gp) html = '<span class="name">' + gp.id.split('(')[0].trim() + '</span><span class="source-badge source-gamepad">Gamepad</span>';
      } else if (activeSource === 'keyboard') {
        html = '<span class="name">Keyboard</span><span class="source-badge source-kbd">Keyboard</span>';
      } else {
        html = '<span style="color:#6b7280;">None connected</span>';
      }
      $('activeSource').innerHTML = html;
    }

    function getWDICommand() {
      if (!wdiState.deviceControlActive) return { cmd: 'CONTROL DISABLED', cls: 'bg-gray' };
      if (wdiState.eStop) return { cmd: 'EMERGENCY_STOP', cls: 'bg-red' };
      if (wdiState.mode === 'seating') {
        if (Math.abs(wdiState.forward) > 0.1) return { cmd: 'SEATING: ' + (wdiState.forward > 0 ? 'UP' : 'DOWN') + ' ' + Math.abs(wdiState.forward * 100).toFixed(0) + '%', cls: 'bg-purple' };
        return { cmd: 'SEATING: IDLE', cls: 'bg-purple-light' };
      }
      var f = wdiState.forward;
      var t = wdiState.turn;
      if (Math.abs(f) < 0.1 && Math.abs(t) < 0.1) return { cmd: 'DRIVE: STOPPED', cls: 'bg-gray' };
      var dir = '';
      if (f > 0.1) dir = 'FORWARD'; else if (f < -0.1) dir = 'REVERSE';
      if (t > 0.1) dir += dir ? ' + RIGHT' : 'RIGHT'; else if (t < -0.1) dir += dir ? ' + LEFT' : 'LEFT';
      return { cmd: 'DRIVE: ' + dir + ' ' + (Math.max(Math.abs(f), Math.abs(t)) * 100).toFixed(0) + '%', cls: 'bg-green' };
    }

    function updateWDIDisplay() {
      var ctrlInd = $('controlIndicator');
      if (wdiState.deviceControlActive) {
        ctrlInd.className = 'control-indicator control-active';
        ctrlInd.textContent = 'DEVICE CONTROL: ACTIVE';
      } else {
        ctrlInd.className = 'control-indicator control-inactive';
        ctrlInd.textContent = 'DEVICE CONTROL: INACTIVE';
      }

      var cmd = getWDICommand();
      var cmdEl = $('commandDisplay');
      cmdEl.className = 'command-display ' + cmd.cls;
      cmdEl.querySelector('.cmd').textContent = cmd.cmd;

      $('joystickKnob').style.left = (50 + wdiState.turn * 40) + '%';
      $('joystickKnob').style.top = (50 - wdiState.forward * 40) + '%';

      $('modeValue').textContent = wdiState.mode.toUpperCase();
      $('modeValue').style.color = wdiState.mode === 'drive' ? '#4ade80' : '#c084fc';
      $('speedValue').textContent = wdiState.speed + '/5';
      $('profileValue').textContent = wdiState.profile;
      $('estopItem').className = 'status-item' + (wdiState.eStop ? ' active' : '');
      $('estopValue').textContent = wdiState.eStop ? 'ACTIVE' : 'Off';

      $('indLeft').className = 'indicator' + (wdiState.leftBlinker ? ' on-orange' : '');
      $('indLight').className = 'indicator' + (wdiState.headlight ? ' on-yellow' : '');
      $('indHazard').className = 'indicator' + (wdiState.hazards ? ' on-red' : '');
      $('indHorn').className = 'indicator' + (wdiState.horn ? ' on-blue' : '');
      $('indRight').className = 'indicator' + (wdiState.rightBlinker ? ' on-orange' : '');
    }

    function updateRawDisplay(source, axes, buttons, raw) {
      var axisNames = source === 'gamepad' ? ['LX', 'LY', 'RX', 'RY', 'A4', 'A5', 'A6', 'A7'] : ['X', 'Y', 'Z', 'Rz'];
      var html = '';

      if (source === 'hid' && raw.hex) {
        html += '<div class="raw-box"><div class="label">Report ID: ' + raw.reportId + '</div><div class="hex">' + raw.hex + '</div></div>';
      }

      if (source === 'gamepad' && raw.buttons) {
        var gp = navigator.getGamepads()[selectedGamepadIndex];
        if (gp) {
          html += '<div class="raw-box"><div class="label">Gamepad Info</div>';
          html += '<div style="font-size:0.7rem;color:#9ca3af;">Mapping: ' + (gp.mapping || 'non-standard') + ' | Connected: ' + gp.connected + ' | Timestamp: ' + gp.timestamp.toFixed(0) + '</div></div>';
        }
      }

      html += '<div class="raw-box"><div class="label">Axes (' + axes.length + ')</div>';
      for (var i = 0; i < axes.length; i++) {
        var val = axes[i];
        var pct = ((val + 1) / 2) * 100;
        var name = axisNames[i] || ('A' + i);
        html += '<div class="axis-row"><span class="name">' + name + ':</span><div class="bar"><div class="bar-fill" style="width:' + pct + '%"></div></div><span class="value">' + val.toFixed(3) + '</span></div>';
      }
      html += '</div>';

      html += '<div class="raw-box"><div class="label">Buttons (' + buttons.length + ')</div><div class="button-grid">';
      for (var j = 0; j < buttons.length; j++) {
        var pressed = buttons[j];
        var pressedClass = pressed ? ' pressed' : '';
        html += '<div class="button-item' + pressedClass + '" title="btn ' + j + '">' + j + '</div>';
      }
      html += '</div>';

      if (source === 'gamepad' && raw.buttons) {
        var activeButtons = [];
        for (var k = 0; k < raw.buttons.length; k++) {
          var btn = raw.buttons[k];
          if (typeof btn === 'object') {
            if (btn.pressed || btn.value > 0) {
              activeButtons.push(k + ': p=' + btn.pressed + ', v=' + btn.value.toFixed(2));
            }
          } else if (btn) {
            activeButtons.push(k + ': ' + btn);
          }
        }
        if (activeButtons.length > 0) {
          html += '<div style="font-size:0.7rem;color:#4ade80;margin-top:0.5rem;">Active: ' + activeButtons.join(', ') + '</div>';
        }
      }

      html += '</div>';
      $('rawDataContainer').innerHTML = html;
    }

    var lastEventTime = 0;
    function addEvent(source, axes, pressedBtns, raw) {
      var now = Date.now();
      if (now - lastEventTime < 50) return;
      lastEventTime = now;

      var ts = new Date().toISOString().split('T')[1].slice(0, -1);
      var axisStr = axes.slice(0, 4).map(function (a) { return a.toFixed(2); }).join(', ');

      events.unshift({ id: eventId++, ts: ts, source: source, axes: axisStr, btns: pressedBtns });
      if (events.length > 100) events.pop();

      var html = '';
      var eventsToShow = events.slice(0, 50);
      for (var i = 0; i < eventsToShow.length; i++) {
        var e = eventsToShow[i];
        var srcCls = e.source === 'hid' ? 'src-hid' : (e.source === 'keyboard' ? 'src-kbd' : 'src-gp');
        var srcLabel = e.source === 'hid' ? 'HID' : (e.source === 'keyboard' ? 'KEY' : 'GP');
        html += '<div class="event-row"><span class="ts">' + e.ts + '</span><span class="src ' + srcCls + '">' + srcLabel + '</span><span class="data">[' + e.axes + ']</span>';
        if (e.btns.length) html += '<span class="btns">' + (e.source === 'keyboard' ? e.btns.join('+') : 'BTN:[' + e.btns.join(',') + ']') + '</span>';
        html += '</div>';
      }
      $('eventLog').innerHTML = html || '<div class="placeholder">No events recorded</div>';
    }

    pollGamepad();
    updateSeatingDisplay();

    function processSeating(buttons) {
      // Only process if we have enough buttons for seating controls
      if (buttons.length <= SEATING_BTN.MEMORY_1) {
        seatingState.memory = null;
        seatingState.tilt = 0;
        seatingState.recline = 0;
        seatingState.legrest = 0;
        seatingState.elevate = 0;
        seatingState.footplates = 0;
        seatingState.stand = 0;
        updateSeatingDisplay();
        return;
      }

      var downMod = buttons[SEATING_BTN.DOWN_MOD] || false;

      // Memory positions (1-6 + Home)
      seatingState.memory = null;
      if (buttons[SEATING_BTN.MEMORY_1]) seatingState.memory = 1;
      else if (buttons[SEATING_BTN.MEMORY_2]) seatingState.memory = 2;
      else if (buttons[SEATING_BTN.MEMORY_3]) seatingState.memory = 3;
      else if (buttons[SEATING_BTN.MEMORY_4]) seatingState.memory = 4;
      else if (buttons[SEATING_BTN.MEMORY_5]) seatingState.memory = 5;
      else if (buttons[SEATING_BTN.MEMORY_6]) seatingState.memory = 6;
      else if (buttons[SEATING_BTN.MEMORY_HOME]) seatingState.memory = 'Home';

      // Actuators: 1 = up/forward, -1 = down/backward, 0 = idle
      // Per WDI spec: button alone = up/forward, button + DOWN_MOD = down/backward
      seatingState.tilt = buttons[SEATING_BTN.TILT] ? (downMod ? -1 : 1) : 0;
      seatingState.recline = buttons[SEATING_BTN.RECLINE] ? (downMod ? -1 : 1) : 0;
      seatingState.legrest = buttons[SEATING_BTN.LEGREST] ? (downMod ? -1 : 1) : 0;
      seatingState.elevate = buttons[SEATING_BTN.ELEVATE] ? (downMod ? -1 : 1) : 0;
      seatingState.footplates = buttons[SEATING_BTN.FOOTPLATES] ? (downMod ? -1 : 1) : 0;
      seatingState.stand = buttons[SEATING_BTN.STAND] ? (downMod ? -1 : 1) : 0;

      updateSeatingDisplay();
    }

    function updateSeatingDisplay() {
      $('memoryValue').textContent = seatingState.memory !== null ? seatingState.memory : 'None';
      $('memoryValue').style.color = seatingState.memory !== null ? '#4ade80' : '#9ca3af';

      var actuators = ['tilt', 'recline', 'legrest', 'elevate', 'footplates', 'stand'];
      var labels = {
        tilt: ['‚óÄ Back', '-', 'Fwd ‚ñ∂'],
        recline: ['‚óÄ Back', '-', 'Fwd ‚ñ∂'],
        legrest: ['‚ñº Down', '-', '‚ñ≤ Up'],
        elevate: ['‚ñº Down', '-', '‚ñ≤ Up'],
        footplates: ['‚ñº Down', '-', '‚ñ≤ Up'],
        stand: ['‚ñº Down', '-', '‚ñ≤ Up']
      };

      for (var i = 0; i < actuators.length; i++) {
        var act = actuators[i];
        var val = seatingState[act];
        var el = $('act' + act.charAt(0).toUpperCase() + act.slice(1));
        var dirEl = $('act' + act.charAt(0).toUpperCase() + act.slice(1) + 'Dir');

        if (val === 0) {
          el.style.background = '#374151';
          dirEl.textContent = labels[act][1];
          dirEl.style.color = '#6b7280';
        } else if (val === 1) {
          el.style.background = '#166534';
          dirEl.textContent = labels[act][2];
          dirEl.style.color = '#4ade80';
        } else {
          el.style.background = '#7c2d12';
          dirEl.textContent = labels[act][0];
          dirEl.style.color = '#fb923c';
        }
      }
    }

    // Keyboard
    var keyboardCapture = $('keyboardCapture');
    var keysPressed = new Set();
    var keyboardActive = false;

    var keyMap = {
      'ArrowUp': 'forward', 'KeyW': 'forward',
      'ArrowDown': 'backward', 'KeyS': 'backward',
      'ArrowLeft': 'left', 'KeyA': 'left',
      'ArrowRight': 'right', 'KeyD': 'right',
      'Space': 'horn',
      'PageUp': 'estop', 'PageDown': 'estop', 'KeyB': 'estop',
      'Enter': 'deviceControlToggle',
      'Escape': 'powerSleep',
      'KeyO': 'menu',
      'Tab': 'modeSwitch',
      'KeyL': 'headlight',
      'KeyH': 'hazards',
      'Comma': 'profileDown', 'Period': 'profileUp',
      'Minus': 'speedDown', 'Equal': 'speedUp',
      'Digit1': 'speed1', 'Digit2': 'speed2', 'Digit3': 'speed3',
      'Digit4': 'speed4', 'Digit5': 'speed5',
      'F1': 'memory1', 'F2': 'memory2', 'F3': 'memory3',
      'F4': 'memory4', 'F5': 'memory5', 'F6': 'memory6', 'F7': 'memoryHome'
    };

    var shiftKeyMap = {
      'Comma': 'leftBlinker',
      'Period': 'rightBlinker',
      'Numpad0': 'tiltUp',
      'Numpad1': 'reclineUp',
      'Numpad2': 'legrestUp',
      'Numpad3': 'elevateUp',
      'Numpad4': 'footplatesUp',
      'NumpadDecimal': 'standUp'
    };

    var ctrlKeyMap = {
      'Numpad0': 'tiltDown',
      'Numpad1': 'reclineDown',
      'Numpad2': 'legrestDown',
      'Numpad3': 'elevateDown',
      'Numpad4': 'footplatesDown',
      'NumpadDecimal': 'standDown'
    };

    function processKeyboard(shiftHeld, ctrlHeld) {
      var fwd = 0, turn = 0;
      if (wdiState.deviceControlActive) {
        if (keysPressed.has('forward')) fwd = 1;
        if (keysPressed.has('backward')) fwd = -1;
        if (keysPressed.has('left')) turn = -1;
        if (keysPressed.has('right')) turn = 1;
      }
      wdiState.forward = fwd;
      wdiState.turn = turn;
      wdiState.eStop = keysPressed.has('estop');
      wdiState.horn = keysPressed.has('horn');

      // Seating from keyboard
      seatingState.tilt = keysPressed.has('tiltUp') ? 1 : (keysPressed.has('tiltDown') ? -1 : 0);
      seatingState.recline = keysPressed.has('reclineUp') ? 1 : (keysPressed.has('reclineDown') ? -1 : 0);
      seatingState.legrest = keysPressed.has('legrestUp') ? 1 : (keysPressed.has('legrestDown') ? -1 : 0);
      seatingState.elevate = keysPressed.has('elevateUp') ? 1 : (keysPressed.has('elevateDown') ? -1 : 0);
      seatingState.footplates = keysPressed.has('footplatesUp') ? 1 : (keysPressed.has('footplatesDown') ? -1 : 0);
      seatingState.stand = keysPressed.has('standUp') ? 1 : (keysPressed.has('standDown') ? -1 : 0);

      updateWDIDisplay();
      updateSeatingDisplay();
      updateKeyboardRawDisplay();
    }

    function updateKeyboardRawDisplay() {
      if (!keyboardActive || keysPressed.size === 0) return;
      var actions = Array.from(keysPressed);
      var html = '<div class="raw-box"><div class="label">Active Keys</div>';
      html += '<div style="color:#4ade80;font-family:monospace;">' + actions.join(', ') + '</div></div>';
      html += '<div class="raw-box"><div class="label">Keyboard Axes (Digital)</div>';
      var kbAxes = [wdiState.turn, -wdiState.forward];
      var names = ['X', 'Y'];
      for (var i = 0; i < 2; i++) {
        var pct = ((kbAxes[i] + 1) / 2) * 100;
        html += '<div class="axis-row"><span class="name">' + names[i] + ':</span><div class="bar"><div class="bar-fill" style="width:' + pct + '%"></div></div><span class="value">' + kbAxes[i].toFixed(1) + '</span></div>';
      }
      html += '</div>';
      $('rawDataContainer').innerHTML = html;
    }

    keyboardCapture.addEventListener('focus', function () {
      keyboardCapture.classList.add('active');
      keyboardCapture.querySelector('div').textContent = 'Keyboard active - press keys';
      keyboardActive = true;
      activeSource = 'keyboard';
      setMappingTab('keyboard');
      updateActiveSource();
    });

    keyboardCapture.addEventListener('blur', function () {
      keyboardCapture.classList.remove('active');
      keyboardCapture.querySelector('div').textContent = 'Click here to capture keyboard';
      keysPressed.clear();
      $('activeKeys').textContent = '';
      keyboardActive = false;
      wdiState.forward = 0;
      wdiState.turn = 0;
      wdiState.eStop = false;
      wdiState.horn = false;
      updateWDIDisplay();
      if (activeSource === 'keyboard') {
        activeSource = selectedGamepadIndex !== null ? 'gamepad' : (hidConnected ? 'hid' : null);
        updateActiveSource();
      }
    });

    keyboardCapture.addEventListener('keydown', function (e) {
      e.preventDefault();
      var shiftHeld = e.shiftKey;
      var ctrlHeld = e.ctrlKey;
      var action;

      if (ctrlHeld && ctrlKeyMap[e.code]) {
        action = ctrlKeyMap[e.code];
      } else if (shiftHeld && shiftKeyMap[e.code]) {
        action = shiftKeyMap[e.code];
      } else {
        action = keyMap[e.code];
      }
      if (!action) return;

      var wasPressed = keysPressed.has(action);
      if (!wasPressed) {
        if (action === 'deviceControlToggle') wdiState.deviceControlActive = !wdiState.deviceControlActive;
        if (action === 'modeSwitch') wdiState.mode = wdiState.mode === 'drive' ? 'seating' : 'drive';
        if (action === 'headlight') wdiState.headlight = !wdiState.headlight;
        if (action === 'hazards') wdiState.hazards = !wdiState.hazards;
        if (action === 'leftBlinker') wdiState.leftBlinker = !wdiState.leftBlinker;
        if (action === 'rightBlinker') wdiState.rightBlinker = !wdiState.rightBlinker;
        if (action === 'menu') wdiState.menuOpen = !wdiState.menuOpen;
        if (action === 'profileUp') wdiState.profile = wdiState.profile >= 5 ? 1 : wdiState.profile + 1;
        if (action === 'profileDown') wdiState.profile = wdiState.profile <= 1 ? 5 : wdiState.profile - 1;
        if (action === 'speedUp' && wdiState.speed < 5) wdiState.speed++;
        if (action === 'speedDown' && wdiState.speed > 1) wdiState.speed--;
        if (action.indexOf('speed') === 0 && action !== 'speedUp' && action !== 'speedDown') {
          var num = parseInt(action.replace('speed', ''));
          if (num >= 1 && num <= 5) wdiState.speed = num;
        }
        // Memory positions
        if (action === 'memory1') seatingState.memory = 1;
        if (action === 'memory2') seatingState.memory = 2;
        if (action === 'memory3') seatingState.memory = 3;
        if (action === 'memory4') seatingState.memory = 4;
        if (action === 'memory5') seatingState.memory = 5;
        if (action === 'memory6') seatingState.memory = 6;
        if (action === 'memoryHome') seatingState.memory = 'Home';

        addEvent('keyboard', [wdiState.turn, -wdiState.forward], [action], null);
      }
      keysPressed.add(action);
      $('activeKeys').textContent = Array.from(keysPressed).join(' + ');
      processKeyboard(shiftHeld, ctrlHeld);
    });

    keyboardCapture.addEventListener('keyup', function (e) {
      e.preventDefault();
      var action = ctrlKeyMap[e.code] || shiftKeyMap[e.code] || keyMap[e.code];
      if (!action) return;
      keysPressed.delete(action);
      if (ctrlKeyMap[e.code]) keysPressed.delete(ctrlKeyMap[e.code]);
      if (shiftKeyMap[e.code]) keysPressed.delete(shiftKeyMap[e.code]);
      if (keyMap[e.code]) keysPressed.delete(keyMap[e.code]);
      $('activeKeys').textContent = Array.from(keysPressed).join(' + ') || '';
      processKeyboard(e.shiftKey, e.ctrlKey);
    });
  </script>
</body>

</html>